generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//
// ENUMS
//

enum Role {
  ADMIN
  MEMBER
  GUEST
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
}

enum PaymentStatus {
  PENDING
  PAID
  PARTIAL
  DEBT
}

enum ScheduleMode {
  FIXED
  RANGE
}

//
// MODELOS
//

model User {
  id            Int            @id @default(autoincrement())
  email         String         @unique
  password      String
  firstName     String
  lastName      String
  phoneNumber   String
  role          Role           @default(MEMBER)
  isProfessor   Boolean        @default(false)

  clubId        Int?
  club          Club?          @relation(fields: [clubId], references: [id])

  bookings      Booking[]
  fixedBookings FixedBooking[]
}

model Club {
  id           Int       @id @default(autoincrement())
  slug         String    @unique
  name         String
  addressLine  String
  city         String
  province     String
  country      String

  locationId   Int?
  location     Location? @relation(fields: [locationId], references: [id])

  contactInfo  String
  phone        String?
  logoUrl      String?
  clubImageUrl String?
  instagramUrl String?
  facebookUrl  String?
  websiteUrl   String?
  description  String?

  // Zona horaria IANA obligatoria
  timeZone     String    @default("America/Argentina/Buenos_Aires")

  lightsEnabled          Boolean @default(false)
  lightsExtraAmount      Float?
  lightsFromHour         String?

  professorDiscountEnabled Boolean @default(false)
  professorDiscountPercent Float?

  scheduleMode            ScheduleMode @default(FIXED)
  scheduleOpenTime        String?
  scheduleCloseTime       String?
  scheduleIntervalMinutes Int?
  scheduleDurations       Json?
  scheduleFixedSlots      Json?

  createdAt    DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt    DateTime  @updatedAt @db.Timestamptz(3)

  courts        Court[]
  users         User[]
  products      Product[]
  cashMovements CashMovement[]
}

model Location {
  id        Int      @id @default(autoincrement())
  city      String
  province  String
  country   String

  createdAt DateTime @default(now()) @db.Timestamptz(3)
  updatedAt DateTime @updatedAt @db.Timestamptz(3)

  clubs     Club[]

  @@unique([city, province, country])
}

model Court {
  id                 Int     @id @default(autoincrement())
  name               String
  isIndoor           Boolean
  surface            String
  isUnderMaintenance Boolean @default(false)
  price              Float   @default(0)

  activityTypeId Int?
  activityType   ActivityType? @relation("CourtActivityType", fields: [activityTypeId], references: [id])

  clubId Int
  club   Club @relation(fields: [clubId], references: [id])

  activities    ActivityType[]
  bookings      Booking[]
  fixedBookings FixedBooking[]

  @@index([clubId])
}

model ActivityType {
  id                     Int            @id @default(autoincrement())
  name                   String
  description            String
  defaultDurationMinutes Int

  primaryCourts          Court[]        @relation("CourtActivityType")
  courts                 Court[]
  bookings               Booking[]
  fixedBookings          FixedBooking[]
}

model Booking {
  id              Int           @id @default(autoincrement())

  startDateTime   DateTime      @db.Timestamptz(3)
  endDateTime     DateTime      @db.Timestamptz(3)

  cancelledBy     Int?
  cancelledAt     DateTime?     @db.Timestamptz(3)

  price           Float
  createdAt       DateTime      @default(now()) @db.Timestamptz(3)

  status          BookingStatus @default(PENDING)
  paymentStatus   PaymentStatus @default(PENDING)

  guestIdentifier String?
  guestName       String?
  guestEmail      String?
  guestPhone      String?
  guestDni        String?

  userId Int?
  user   User? @relation(fields: [userId], references: [id])

  courtId Int
  court   Court @relation(fields: [courtId], references: [id])

  activityId Int
  activity   ActivityType @relation(fields: [activityId], references: [id])

  fixedBookingId Int?
  fixedBooking   FixedBooking? @relation(fields: [fixedBookingId], references: [id])

  items          BookingItem[]
  cashMovements  CashMovement[]

  @@index([courtId, startDateTime])
  @@index([startDateTime])
}

model FixedBooking {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now()) @db.Timestamptz(3)

  dayOfWeek Int
  startTime String
  endTime   String
  startDate DateTime @db.Timestamptz(3)

  status     String   @default("ACTIVE")
  guestPhone String?
  guestDni   String?
  guestName  String?

  userId     Int?
  user       User? @relation(fields: [userId], references: [id])

  courtId    Int
  court      Court @relation(fields: [courtId], references: [id])

  activityId Int
  activity   ActivityType @relation(fields: [activityId], references: [id])

  bookings Booking[]

  @@index([courtId, dayOfWeek])
}

model Product {
  id       Int     @id @default(autoincrement())
  name     String
  category String?
  price    Decimal @db.Decimal(10, 2)
  stock    Int     @default(0)
  minStock Int     @default(5)
  isActive Boolean @default(true)

  clubId Int
  club   Club @relation(fields: [clubId], references: [id])

  createdAt DateTime @default(now()) @db.Timestamptz(3)
  updatedAt DateTime @updatedAt @db.Timestamptz(3)

  bookingItems BookingItem[]

  @@index([clubId])
}

model BookingItem {
  id Int @id @default(autoincrement())

  bookingId Int
  booking   Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  productId Int
  product   Product @relation(fields: [productId], references: [id])

  quantity Int
  price    Float
}

model CashMovement {
  id          Int      @id @default(autoincrement())
  date        DateTime @default(now()) @db.Timestamptz(3)

  type        String
  amount      Float
  description String
  method      String

  bookingId Int?
  booking   Booking? @relation(fields: [bookingId], references: [id])

  clubId Int
  club   Club @relation(fields: [clubId], references: [id])

  @@index([clubId, date])
}